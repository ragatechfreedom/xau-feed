<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XAUUSD Live (Compact)</title>
<style>
  :root{color-scheme:dark light}
  body{margin:0;background:#0b0e11;color:#e6e8ea;font-family:system-ui,Arial,Helvetica,sans-serif;font-size:10px}
  .ticker{display:flex;gap:10px;align-items:center;padding:8px 10px;background:#11161c;border-bottom:1px solid #1b232d;position:sticky;top:0;z-index:2}
  .pair{font-weight:700;letter-spacing:.3px}
  .price{font-size:18px;font-weight:800}
  .chg{padding:1px 6px;border-radius:999px;font-weight:700;font-size:11px}
  .up{background:#0f2b17;color:#55d88a}.down{background:#2b1515;color:#ff7b7b}
  .muted{opacity:.7;font-size:11px}
  .wrap{max-width:1100px;margin:0 auto;padding:8px 10px}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .controls select,.controls button{background:#11161c;border:1px solid #1b232d;color:#e6e8ea;border-radius:8px;padding:4px 8px;font-size:12px}
  .status{font-size:11px;opacity:.85;margin:6px 0}
  .tablewrap{overflow:auto;border:1px solid #1b232d;border-radius:10px}
  table{width:100%;border-collapse:collapse;font-variant-numeric:tabular-nums}
  thead th {top: 0; background:#0e1319; z-index: 2; }
.tablewrap { overflow:auto; max-height: calc(100vh - 160px); border:1px solid #1b232d; border-radius:10px; }
/* biar header nggak “nembus” baris */
thead th { box-shadow: 0 1px 0 #1b232d; }

  th,td{padding:3px 6px;border-bottom:1px solid #1b232d;text-align:right;line-height:1.1}
  th:first-child,td:first-child{text-align:left}
  /* Dense mode = lebih kecil lagi */
  body.dense {font-size:8px}
  body.dense .price{font-size:16px}
  body.dense th, body.dense td{padding:2px 4px}
</style>
</head>
<body>

<div class="ticker">
  <span class="pair" id="pair">XAUUSD</span>
  <span class="price" id="price">—</span>
  <span class="chg" id="chg">—</span>
  <span class="muted" id="time">—</span>
</div>

<div class="wrap">
  <div class="controls">
    <label>Rows:
      <select id="limit">
        <option value="50">50</option>
        <option value="100" selected>100</option>
        <option value="200">200</option>
        <option value="500">500</option>
        <option value="-1">All</option>
      </select>
    </label>
    <button id="density">Dense</button>
    <span class="status" id="status">Menunggu data…</span>
  </div>

  <div class="tablewrap">
    <table>
      <thead>
        <tr>
          <th>Waktu (UTC)</th>
          <th>Open</th>
          <th>High</th>
          <th>Low</th>
          <th>Close</th>
          <th>Vol</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script>
const URL_LATEST="data/xau_latest.json";
const URL_M1_JL ="data/xau_m1.jsonl";
const elPair=document.getElementById("pair");
const elPrice=document.getElementById("price");
const elChg=document.getElementById("chg");
const elTime=document.getElementById("time");
const elRows=document.getElementById("rows");
const elStatus=document.getElementById("status");
const elLimit=document.getElementById("limit");
const btnDensity=document.getElementById("density");

const fmt=(n,d=2)=>Number.isFinite(+n)?(+n).toFixed(d):"—";
const iso=ts=>ts?(typeof ts==="number"?new Date(ts).toISOString():String(ts)):"—";

async function fetchJSON(u){
  const r=await fetch(u+"?t="+Date.now(),{cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function fetchJSONL(u){
  const r=await fetch(u+"?t="+Date.now(),{cache:"no-store"});
  if(!r.ok) throw new Error("HTTP "+r.status);
  const text=await r.text(); const rows=[];
  for(const line of text.split("\n")){const s=line.trim(); if(!s) continue; try{rows.push(JSON.parse(s))}catch{}}
  return rows;
}

function renderTable(rows){
  // newest first
  const arr=rows.slice().sort((a,b)=>(b.ts_ms||0)-(a.ts_ms||0));
  const lim=parseInt(elLimit.value,10);
  const view=(lim<0)?arr:arr.slice(0,lim);
  // build once for speed
  let html="";
  for(const r of view){
    html+=`<tr>
      <td>${iso(r.ts_ms)}</td>
      <td>${fmt(r.open)}</td>
      <td>${fmt(r.high)}</td>
      <td>${fmt(r.low)}</td>
      <td>${fmt(r.close)}</td>
      <td>${r.volume??"—"}</td>
    </tr>`;
  }
  elRows.innerHTML=html;
}

function renderTicker({latest,last,prev}){
  elPair.textContent=(latest?.symbol)||(last?.symbol)||"XAUUSD";
  let price=Number.isFinite(+last?.close)?+last.close:null;
  let ts=last?.ts_ms??null;
  if(!price && latest){
    if(Number.isFinite(+latest.mid)) price=+latest.mid;
    else if(Number.isFinite(+latest.close)) price=+latest.close;
    else if(Number.isFinite(+latest.bid)&&Number.isFinite(+latest.ask)) price=(+latest.bid+ +latest.ask)/2;
    ts=latest.ts_ms??latest.time;
  }
  elPrice.textContent=price?price.toFixed(2):"—";
  elTime.textContent=ts?iso(ts):"—";

  if(Number.isFinite(price)&&Number.isFinite(+prev?.close)){
    const diff=price-(+prev.close);
    const pct=(price/(+prev.close)-1)*100;
    elChg.textContent=`${diff.toFixed(2)} (${pct.toFixed(2)}%)`;
    elChg.className="chg "+(diff>=0?"up":"down");
  }else{elChg.textContent="—"; elChg.className="chg";}
}

async function refresh(){
  try{
    const [latest,m1]=await Promise.all([
      fetchJSON(URL_LATEST).catch(()=>null),
      fetchJSONL(URL_M1_JL).catch(()=>[])
    ]);
    m1.sort((a,b)=>(a.ts_ms||0)-(b.ts_ms||0));
    const last=m1[m1.length-1]||null;
    const prev=m1[m1.length-2]||null;
    renderTicker({latest,last,prev});
    renderTable(m1);
    elStatus.textContent=`Bars: ${m1.length}${elLimit.value>0?` • showing ${elLimit.value}`:""}`;
  }catch(e){
    console.error(e); elStatus.textContent="Gagal memuat data";
  }
}

elLimit.addEventListener("change",refresh);
btnDensity.addEventListener("click",()=>{
  document.body.classList.toggle("dense");
  btnDensity.textContent=document.body.classList.contains("dense")?"Comfy":"Dense";
});

refresh();
setInterval(refresh,20000);
</script>
</body>
</html>
